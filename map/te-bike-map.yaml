import: https://mapzen.com/carto/refill-style/2/refill-style.yaml

sources:
    osm: 
        type: TopoJSON
        url: //vector.mapzen.com/osm/all/{z}/{x}/{y}.topojson?api_key=vector-tiles-JUsa0Gc
#        rasters: [normals]
        max_zoom: 16
#    normals:
#        type: Raster
#        url: https://terrain-preview.mapzen.com/normal/{z}/{x}/{y}.png
#        max_zoom: 14

styles:
    casing_left:
        base: lines
        texcoords: true
        shaders:
            defines:
                FLIP: true
                LINE_WIDTH:  0.0001
                SPIKE_WIDTH: 1.
                SPIKE_SCALE: 2.
            blocks:
                global: |
                    float pulse(float x,float p, float w){
                        x = abs(x - p);
                        if( x>w ) return 0.0;
                        x /= w;
                        return 1.0 - x*x*(3.0-2.0*x);
                    }
                color: |
                    vec2 st = v_texcoord.xy;
                    #ifdef FLIP
                    st.x = 1. - st.x;
                    #endif
                    float pattern = step(.5,  pulse(st.x,0.5,LINE_WIDTH) + pulse(st.x,0.146,LINE_WIDTH));
                    pattern += (step(.5,st.x))*pulse(fract(st.y*SPIKE_SCALE),.1,SPIKE_WIDTH);
                    if (pattern==0.) {
                        discard;
                    }
    casing_right:
        base: lines
        texcoords: true
        shaders:
            defines:
                FLIP: false
                LINE_WIDTH:  0.0001
                SPIKE_WIDTH: 1.
                SPIKE_SCALE: 2.
            blocks:
                global: |
                    float pulse(float x,float p, float w){
                        x = abs(x - p);
                        if( x>w ) return 0.0;
                        x /= w;
                        return 1.0 - x*x*(3.0-2.0*x);
                    }
                color: |
                    vec2 st = v_texcoord.xy;
                    #ifdef FLIP
                    st.x = 1. - st.x;
                    #endif
                    float pattern = step(.5,  pulse(st.x,0.5,LINE_WIDTH) + pulse(st.x,0.146,LINE_WIDTH));
                    pattern += (step(.5,st.x))*pulse(fract(st.y*SPIKE_SCALE),.1,SPIKE_WIDTH);
                    if (pattern==0.) {
                        discard;
                    }
layers:
    bicycle-roads:
        data: { source: osm, layer: roads }
        filter: 
            all:
                - $zoom: { min: 12 }
            any:
                - is_bicycle_related: true
                - bicycle: [yes, designated]
        draw:
            lines:
                interactive: true
                color: [0.460,0.640,1.000]
                width: [[11, 1px], [12, 1.2px], [13, 1.5px],[14,1.6px],[15,1.9px],[16,0.01px]]
                # let roads sort themselves past zoom 14
                order: 490
                outline:
                    order: 486
                    color: [0.182,0.593,0.730]
                    width: [[15, 0px],[16, 0.5px],[17, 1px]]
        cycleway-path-early:
                filter: 
                    all:
                        - highway: [cycleway, track, path, footway, steps]
                        - $zoom: { max: 16 }
                        - not:
                            any:
                                - cycleway: [lane, track, opposite, opposite_lane, opposite_track, sidepath]
                                - cycleway_left: [lane, track, opposite, opposite_lane, opposite_track, sidepath]
                                - cycleway_right: [lane, track, opposite, opposite_lane, opposite_track, sidepath]
                draw:
                    lines:
                        color: '#99ce9c'
                early-z15:
                    filter: { $zoom: [14,15] }
                    draw:
                        lines:
                            color: '#54b356'
                track:
                    filter: { highway: track }
                    draw:
                        lines:
                            color: '#cfbe99'
                    early-z15:
                        filter: { $zoom: [14,15] }
                        draw:
                            lines:
                                color: '#b39654'
        separated_bike_lanes_tracks_etc-early:
            filter: 
                 all:
                    - not: { highway: [cycleway, track, path, footway, steps] }
                    - $zoom: [14,15]
                 any:
                    - cycleway: [lane, track, opposite, opposite_lane, opposite_track, sidepath]
                    - cycleway_left: [lane, track, opposite, opposite_lane, opposite_track, sidepath]
                    - cycleway_right: [lane, track, opposite, opposite_lane, opposite_track, sidepath]
            draw:
                lines:
                    color: '#3b69fe'
                    width: 2.2px
        labels-cycleway:
            filter: { $zoom: { min: 17 } }
            draw:
                text-blend-order:
                    priority: 58
                    text_source: |
                        function() {
                            if( (feature.highway == 'cycleway' && feature.cycleway == 'sidepath' || feature.cycleway == 'segregated') || 
                                (feature.highway == 'footway'  && feature.bicycle == 'yes' && feature.segregated == 'yes' ) 
                            ) {
                                return "Sidepath"; 
                            } else if( feature.highway == "cycleway" && feature.cycleway != 'sidepath' ) { 
                                return "Bike path";
                            } else if( feature.highway == "footway" && (feature.bicycle == 'designated' || feature.bicycle == 'yes') ) { 
                                return "Designated footway";
                            } else if( feature.highway == "steps" && (feature.bicycle == 'designated' || feature.bicycle == 'yes') ) { 
                                return "Designated steps";
                            } else if( feature.kind == 'path' && (feature.bicycle == 'designated' || feature.bicycle == 'yes') ) {
                                return "Designated path"; 
                            } else if( feature.kind == 'track' && (feature.bicycle == 'designated' || feature.bicycle == 'yes') ) {
                                return "Designated track";
                            } else if( feature.cycleway && feature.oneway == 'yes' ) {
                                return feature.cycleway + " (implied right)";
                            } else if( feature.cycleway ) {
                                return feature.cycleway + " (both sides)"; 
                            } else if( feature.cycleway_left && feature.cycleway_right ){ 
                                return feature.cycleway_left + " (left) & " + feature.cycleway_right + " (right)";
                            } else if( feature.cycleway_left ){ 
                                return feature.cycleway_left + " (left side)";
                            } else if ( feature.cycleway_right ){ 
                                return feature.cycleway_right + " (right side)"; 
                            } else { 
                                return "Designated route only";
                            }
                        }
                    font:
                        fill: blue #[0.143,0.544,0.481]
                        style: italic
                        size: 12px
                        stroke: { color: white, width: 4 }
        double-lines:
            filter: { $zoom: { min: 16 } }
            draw:
                lines:
                    color: [[16,[1.00,1.00,1.00]], [17,'#dbe6f9']]
                    width: [[15,0px],[16,1px],[17,4px],[18,6m]]
                    outline:
                        color: [0.460,0.640,1.000]
                        width: [[15, 0.5px],[16, 1.5px],[17, 1.5px],[18, 2.5px],[19, 1m]]
                casing_left:
                    visible: false
                    order: 486
                    color: [0.460,0.640,1.000]
                    width: [[15, 0.5px],[16, 5.5px],[17, 10px],[18, 9m],[19, 8m]]
                casing_right:
                    visible: false
                    order: 486
                    color: white
                    width: [[15, 0.5px],[16, 6px],[17, 10px],[18, 9m],[19, 8m]]
            labels-early:
                filter: { $zoom: [16] }
                draw:
                    text-blend-order:
                        visible: false
            cycleway-path:
                filter: 
                    any:
                        - { highway: cycleway }
                        - { highway: path, bicycle: [designated, yes] }
                        - { highway: track, bicycle: [designated, yes] }
                        - { highway: footway, bicycle: [designated, yes] }
                        - { highway: steps, bicycle: [designated, yes] }
                    not:
                        - { highway: footway, bicycle: yes, segregated: yes }
                draw:
                    lines:
                        order: 486
                        color: '#99ce9c'
                        outline:
                            color: [[16,'#54b356'],[17,'#3ba53d'],[18,green]]
                    text-blend-order:
                        font:
                            fill: green
                footway_steps:
                    filter: { highway: [footway, steps] }
                    draw:
                        lines:
                            color: '#afdcb2'
                            width: [[15,0px],[16,0.6px],[17,2.0px],[18,3m]]
                            outline:
                                color: [[16,'#6abe6c'],[17,'#5cb65e']]
                                width: [[15, 0.5px],[16, 1.5px],[17, 1px],[18, 2px],[19, 0.7m]]
                    steps:
                        filter: { highway: steps }
                        draw:
                            lines:
                                color: '#eac6c6'
                                outline:
                                    color: [[16,'#bf6b6b'],[17,'#b04d4d']]
                            text-blend-order:
                                font:
                                    fill: '#b04d4d'
                tracks:
                    filter: { highway: track }
                    draw:
                        lines:
                            order: 487
                            color: '#cebe99'
                            outline:
                                color: [[16,'#b39654'],[17,'#a6863c'],[18,'#826219']]
                        text-blend-order:
                            font:
                                fill: '#826219'
            separated_bike_lanes_tracks_etc:
                filter: 
                     all:
                        - not: { highway: [cycleway, track, path, footway, steps] }
                     any:
                        - cycleway: [lane, track, opposite, opposite_lane, opposite_track]
                        - cycleway_left: [lane, track, opposite, opposite_lane, opposite_track]
                        - cycleway_right: [lane, track, opposite, opposite_lane, opposite_track]
                draw:
                    lines:
                        outline:
                            order: 488
                            color: blue
                    casing_left:
                        color: white
                    casing_right:
                        color: blue
                left_or_right_or_implied:
                    filter:
                        any:
                            - cycleway_left: true
                            - cycleway_right: true
                            - all:
                                - cycleway: true
                                - oneway: yes
                    draw:
                        lines:
                            color: [[16,'#dbe6f9'], [17,'#dbe6f9']]
                            width: [[15,1px],[16,3px],[17,6.5px],[18,6m]]
                            outline:
                                visible: false
                                width: 0px
                        casing_left:
                            visible: true
                        casing_right:
                            visible: true
                    left_is_special:
                        filter:
                            any:
                                - cycleway_left: true
                                - cycleway: opposite
                        draw:
                            casing_left:
                                color: blue
                            casing_right:
                                color: white
                        omg_oneway_bicycle:
                            filter: { cycleway: [opposite, opposite_lane], oneway_bicycle: no }
                            draw:
                                casing_right:
                                    color: blue
                    shared_lane:
                        filter:
                             any:
                                - cycleway: [shared_lane, shared]
                                - cycleway_left: [shared_lane, shared]
                                - cycleway_right: [shared_lane, shared]
                        draw:
                            lines:
                                color: '#fffbca'
                            casing_right:
                                color: [0.460,0.640,1.000]
            shared_lane:
                filter:
                     any:
                        - cycleway: [shared_lane, shared]
                        - cycleway_left: [shared_lane, shared]
                        - cycleway_right: [shared_lane, shared]
                draw:
                    lines:
                        order: 489
                        color: '#fffbca'
                    text-blend-order:
                        font:
                            stroke:
                                color: '#fffbca'
            sidepath:
                filter:
                    any:
                        - cycleway: [sidepath, segregated]
                        - cycleway_left: [sidepath, segregated]
                        - cycleway_right: [sidepath, segregated]
                        - { highway: footway, bicycle: yes, segregated: yes }
                draw:
                    lines:
                        order: 491
                        width: [[15,0px],[16,1.2px],[17,2.5px],[18,2.5m]]
                        color: [0.460,0.640,1.000]  #blue
                        outline:
                            width: 0px
                    text-blend-order:
                        font:
                            fill: blue
